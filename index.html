<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>RUTHASH - Telegram Miner (Версия v2.3.3)</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700&family=Exo+2:wght@300;400;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary: #6a11cb; --secondary: #2575fc; --accent: #2ecc71; --gold: #f1c40f; --bronze: #cd7f32; 
            --silver: #c0c0c0; --danger: #ff416c; --dark: #1a1a2e; --darker: #16213e; --glass: rgba(255,255,255,0.08);
            --glass-border: rgba(255,255,255,0.15); --glass-highlight: rgba(255,255,255,0.05);
        }
        
        * { box-sizing: border-box; margin: 0; padding: 0; font-family: 'Exo 2', sans-serif; -webkit-tap-highlight-color: transparent; }
        
        body { 
            background: linear-gradient(135deg, var(--darker), var(--dark)); color: #f0f0f0; min-height: 100vh; 
            padding: 0; overflow-x: hidden; position: relative; 
        }
        
        #particles-background { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: -1; pointer-events: none; }
        
        .container { max-width: 100%; margin: 0 auto; padding: 0 15px 80px; }
        
        header { 
            text-align: center; margin-bottom: 20px; padding: 12px 15px 25px; background: var(--glass); 
            border-radius: 0 0 20px 20px; backdrop-filter: blur(12px); border: 1px solid var(--glass-border); 
            box-shadow: 0 8px 32px rgba(0,0,0,0.3); position: sticky; top: 0; z-index: 10; 
        }
        
        .logo { display: flex; align-items: center; justify-content: center; gap: 10px; margin-bottom: 8px; position: relative; }
        .logo-icon { 
            width: 45px; height: 45px; background: linear-gradient(45deg, var(--primary), var(--secondary)); 
            border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: bold; 
            font-size: 22px; box-shadow: 0 0 15px rgba(106,17,203,0.5); 
        }
        .logo-text {
            font-family: 'Orbitron', sans-serif; font-weight: bold; font-size: 1.8rem; letter-spacing: 1px; 
            background: linear-gradient(45deg, #6a11cb, #2575fc, #2ecc71); -webkit-background-clip: text; 
            -webkit-text-fill-color: transparent; text-shadow: 0 2px 10px rgba(0,0,0,0.2);
        }
        .rutcoin-display {
            position: absolute; bottom: 8px; left: 50%; transform: translateX(-50%); background: rgba(241,196,15,0.1);
            padding: 5px 10px; border-radius: 20px; font-weight: bold; color: var(--gold); border: 1px solid rgba(241,196,15,0.3);
            display: flex; align-items: center; gap: 5px; font-size: 0.85rem; white-space: nowrap;
        }
        
        .dashboard { display: grid; grid-template-columns: 1fr; gap: 15px; margin-bottom: 20px; }
        
        .card {
            background: var(--glass); border-radius: 20px; padding: 20px; backdrop-filter: blur(10px); 
            border: 1px solid var(--glass-border); box-shadow: 0 8px 32px rgba(0,0,0,0.2); transition: transform 0.3s ease, box-shadow 0.3s ease;
            position: relative; overflow: hidden;
        }
        .card::before {
            content: ''; position: absolute; top: 0; left: 0; width: 100%; height: 100%; 
            background: linear-gradient(120deg, transparent, var(--glass-highlight), transparent); z-index: -1;
        }
        .card:hover { transform: translateY(-5px); box-shadow: 0 12px 40px rgba(0,0,0,0.3); }
        
        .card-title { font-size: 1.1rem; margin-bottom: 15px; color: var(--accent); display: flex; align-items: center; gap: 8px; }
        
        .stats { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
        .stat-item { background: rgba(0,0,0,0.2); border-radius: 15px; padding: 12px; transition: all 0.3s ease; }
        .stat-item:hover { background: rgba(0,0,0,0.3); transform: scale(1.02); }
        .stat-item h3 { font-size: 0.8rem; opacity: 0.7; margin-bottom: 5px; }
        .stat-value { font-size: 1.4rem; font-weight: bold; color: var(--accent); transition: all 0.3s ease; }
        .gold-value { color: var(--gold); }
        
        .mining-area { text-align: center; margin: 20px 0; padding: 15px; background: rgba(0,0,0,0.3); border-radius: 20px; position: relative; overflow: hidden; }
        .mining-area::before {
            content: ''; position: absolute; top: 0; left: 0; width: 100%; height: 3px; 
            background: linear-gradient(90deg, var(--primary), var(--secondary));
        }
        .hashes { font-size: 2.8rem; font-weight: bold; color: var(--accent); text-shadow: 0 0 15px rgba(46,204,113,0.6); margin: 10px 0; transition: all 0.5s ease; }
        .coins { font-size: 1.6rem; font-weight: bold; color: var(--gold); margin: 10px 0; transition: all 0.5s ease; }
        
        .controls { display: flex; flex-direction: column; gap: 12px; }
        .btn-group { display: flex; gap: 10px; margin-top: 10px; }
        
        .btn {
            flex: 1; padding: 14px; border: none; border-radius: 15px; font-size: 1rem; font-weight: bold; cursor: pointer; 
            transition: all 0.2s ease; color: white; display: flex; align-items: center; justify-content: center; gap: 8px; 
            box-shadow: 0 4px 15px rgba(0,0,0,0.2); position: relative; overflow: hidden; z-index: 1;
            background: linear-gradient(45deg, var(--primary), var(--secondary));
        }
        .btn::before {
            content: ''; position: absolute; top: 0; left: 0; width: 100%; height: 100%; 
            background: linear-gradient(45deg, rgba(255,255,255,0.1), rgba(255,255,255,0.3)); z-index: -1; 
            transition: opacity 0.3s ease; opacity: 0;
        }
        .btn:hover::before { opacity: 1; }
        .btn:active { transform: scale(0.98); }
        .btn-stop { background: linear-gradient(45deg, #ff416c, #ff4b2b); }
        .btn-upgrade { background: linear-gradient(45deg, #f1c40f, #f39c12); }
        .btn-buy { background: linear-gradient(45deg, #27ae60, #2ecc71); }
        .btn-claim { background: linear-gradient(45deg, #9b59b6, #8e44ad); }
        .btn-danger { background: linear-gradient(45deg, #e74c3c, #c0392b); }
        .btn-exchange { background: linear-gradient(45deg, #16a085, #1abc9c); }
        .btn-luck { background: linear-gradient(45deg, #e74c3c, #e67e22); }
        .btn-premium { background: linear-gradient(45deg, #d4af37, #ffd700); }
        .btn-inventory { background: linear-gradient(45deg, #2ecc71, #1abc9c); }
        .btn-disabled { opacity: 0.6; cursor: not-allowed; }
        .btn-reset { background: linear-gradient(45deg, #e74c3c, #c0392b); margin-top: 20px; }
        
        .info { font-size: 0.85rem; opacity: 0.8; margin-top: 15px; line-height: 1.5; }
        .info ul { padding-left: 20px; margin-top: 10px; }
        .info li { margin-bottom: 8px; }
        .disclaimer {
            background: rgba(192,57,43,0.2); border-left: 4px solid #e74c3c; padding: 12px; border-radius: 0 10px 10px 0; 
            margin-top: 20px; font-size: 0.8rem;
        }
        
        .telegram-btn {
            display: block; width: 100%; text-align: center; margin-top: 15px; padding: 12px; background: #0088cc; 
            color: white; border-radius: 15px; text-decoration: none; font-weight: bold; transition: all 0.3s ease;
        }
        .telegram-btn:hover { background: #0066a6; transform: translateY(-2px); }
        
        .user-id, .version { font-size: 0.7rem; text-align: center; opacity: 0.6; }
        .user-id { margin-top: 10px; }
        .version { margin-top: 3px; }
        
        .upgrade-container, .quest-container, .luck-container, .inventory-container, .exchange-container, .leaderboard-list, .feature-grid, .stats-grid { 
            display: grid; gap: 10px; margin-top: 15px; 
        }
        .upgrade-container, .quest-container, .luck-container { grid-template-columns: 1fr; }
        .inventory-container { grid-template-columns: repeat(auto-fill, minmax(120px, 1fr)); }
        .feature-grid, .stats-grid { grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; margin: 30px 0; }
        .stats-grid { gap: 15px; }
        
        .upgrade-item, .quest-item, .feature-card, .stat-card, .inventory-item {
            background: var(--glass); border-radius: 15px; padding: 15px; border: 1px solid var(--glass-border);
            transition: all 0.3s ease;
        }
        .upgrade-item:hover, .quest-item:hover, .feature-card:hover, .stat-card:hover, .inventory-item:hover { transform: translateY(-3px); }
        .luck-item { background: rgba(231,76,60,0.2); }
        .premium-item { background: rgba(233,212,96,0.2); }
        .inventory-item { background: rgba(46,204,113,0.2); }
        .leaderboard-item { background: rgba(155,89,182,0.2); }
        
        .upgrade-header, .quest-header { display: flex; justify-content: space-between; align-items: center; }
        .upgrade-title, .quest-title { font-weight: bold; font-size: 0.95rem; }
        .quest-title { color: #9b59b6; }
        .upgrade-cost, .quest-reward {
            background: rgba(241,196,15,0.2); padding: 4px 10px; border-radius: 20px; color: var(--gold);
            font-size: 0.9rem; display: flex; align-items: center; gap: 5px;
        }
        .quest-reward { font-size: 0.85rem; padding: 4px 8px; }
        
        .progress-container, .quest-progress, .progress-timer {
            width: 100%; height: 8px; background: rgba(255,255,255,0.1); border-radius: 10px; margin-top: 10px; overflow: hidden;
        }
        .progress-timer { height: 10px; border-radius: 5px; margin-top: 10px; }
        .progress-bar, .quest-progress-bar, .progress-timer-bar {
            height: 100%; border-radius: 10px; transition: width 0.5s ease;
            background: linear-gradient(90deg, var(--primary), var(--secondary));
        }
        .quest-progress-bar { background: linear-gradient(90deg, #9b59b6, #8e44ad); }
        
        .upgrade-benefit, .quest-status { display: flex; justify-content: space-between; font-size: 0.9rem; margin-top: 5px; }
        .quest-status { font-size: 0.85rem; }
        .power-level { display: flex; justify-content: space-between; margin-top: 10px; font-size: 0.9rem; padding: 8px; background: rgba(0,0,0,0.2); border-radius: 10px; }
        .power-level span { color: var(--accent); font-weight: bold; }
        .format-number { font-size: 1.2rem; }
        
        .mining-level { display: flex; align-items: center; justify-content: center; margin: 15px 0; }
        .mining-level span { font-size: 2.5rem; font-weight: bold; color: var(--gold); margin: 0 10px; }
        .mining-level-btn {
            width: 40px; height: 40px; border-radius: 50%; background: rgba(255,255,255,0.1); display: flex; 
            align-items: center; justify-content: center; font-size: 1.5rem; cursor: pointer; transition: all 0.3s ease;
        }
        .mining-level-btn.disabled { opacity: 0.3; cursor: not-allowed; }
        .mining-level-btn:not(.disabled):hover { background: rgba(106,17,203,0.3); transform: scale(1.1); }
        
        .roll-container {
            position: relative; width: 100%; height: 180px; margin: 20px auto; overflow: hidden; border-radius: 15px; 
            border: 2px solid var(--gold); box-shadow: 0 0 20px rgba(241,196,15,0.3); background: linear-gradient(135deg, #1a1a2e, #16213e);
        }
        .roll-items { display: flex; height: 100%; transition: transform 3s cubic-bezier(0.17,0.67,0.83,0.67); }
        .roll-item { min-width: 25%; display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 15px; text-align: center; }
        .roll-item-icon { font-size: 3rem; margin-bottom: 10px; }
        .roll-item-name { font-size: 1rem; font-weight: bold; margin-bottom: 5px; }
        .roll-item-desc { font-size: 0.8rem; opacity: 0.8; }
        .roll-pointer {
            position: absolute; top: -15px; left: 50%; transform: translateX(-50%); width: 30px; height: 30px; background: var(--gold);
            clip-path: polygon(50% 100%, 0 0, 100% 0); z-index: 10; filter: drop-shadow(0 3px 5px rgba(0,0,0,0.5));
        }
        .spin-button {
            padding: 15px 25px; border-radius: 15px; color: white; border: none; font-weight: bold; cursor: pointer; 
            transition: all 0.3s ease; font-size: 1.1rem; display: flex; align-items: center; justify-content: center; 
            gap: 10px; margin: 10px auto; width: 80%; box-shadow: 0 0 20px rgba(0,0,0,0.5);
            background: linear-gradient(45deg, var(--primary), var(--secondary));
        }
        .spin-button i { font-size: 1.8rem; }
        .premium-button { background: linear-gradient(45deg, #d4af37, #ffd700); }
        .spin-button:disabled { opacity: 0.7; cursor: not-allowed; }
        .roll-info { text-align: center; margin-top: 15px; font-size: 1.1rem; }
        .roll-timer { font-size: 1rem; color: var(--accent); font-weight: bold; margin-top: 5px; }
        
        .notification {
            position: fixed; top: 20px; left: 50%; transform: translateX(-50%); background: rgba(46,204,113,0.9); 
            color: white; padding: 10px 20px; border-radius: 10px; z-index: 1000; display: none; 
            box-shadow: 0 5px 15px rgba(0,0,0,0.3); animation: fadeInOut 3s ease;
        }
        @keyframes fadeInOut {
            0% { opacity: 0; transform: translate(-50%, -20px); }
            10% { opacity: 1; transform: translate(-50%, 0); }
            90% { opacity: 1; transform: translate(-50%, 0); }
            100% { opacity: 0; transform: translate(-50%, -20px); }
        }
        
        .tab-content { display: none; opacity: 0; transform: translateY(10px); transition: all 0.4s ease; }
        .tab-content.active { display: block; opacity: 1; transform: translateY(0); }
        
        .nav-container {
            position: fixed; bottom: 0; left: 0; width: 100%; background: rgba(30,40,60,0.9); backdrop-filter: blur(12px); 
            border-top: 1px solid var(--glass-border); z-index: 100; display: flex; justify-content: space-around; padding: 10px 0;
        }
        .nav-btn {
            display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 5px; padding: 8px 5px; 
            border-radius: 15px; background: transparent; border: none; color: rgba(255,255,255,0.6); font-size: 0.7rem; 
            cursor: pointer; transition: all 0.3s ease; width: 14%; position: relative;
        }
        .nav-btn:after {
            content: ''; position: absolute; bottom: 0; left: 50%; transform: translateX(-50%); width: 0; height: 3px; 
            background: var(--accent); transition: all 0.3s ease;
        }
        .nav-btn.active, .nav-btn:hover { color: white; }
        .nav-btn.active:after { width: 70%; }
        .nav-btn i { font-size: 1.1rem; transition: all 0.3s ease; }
        .nav-btn:hover i { transform: scale(1.2); }
        
        .footer-info {
            position: fixed; bottom: 55px; left: 0; width: 100%; display: flex; justify-content: space-between; 
            padding: 5px 15px; font-size: 0.7rem; opacity: 0.6; z-index: 99;
        }
        .footer-left { text-align: left; }
        .footer-right { text-align: right; }
        
        .exchange-form { display: flex; flex-direction: column; gap: 10px; margin-top: 15px; }
        .exchange-form label { font-weight: bold; }
        .exchange-form input {
            padding: 12px; border-radius: 10px; border: none; background: rgba(255,255,255,0.1); color: white; font-size: 1rem;
        }
        .exchange-form input:focus { outline: 2px solid var(--accent); }
        .exchange-result { background: rgba(22,160,133,0.2); border-radius: 10px; padding: 15px; margin-top: 10px; }
        .exchange-result p { margin: 5px 0; }
        .exchange-rates { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 10px; }
        .rate-item { background: rgba(255,255,255,0.1); border-radius: 10px; padding: 10px; text-align: center; }
        .exchange-chart { height: 200px; background: var(--glass); border-radius: 15px; margin: 20px 0; padding: 15px; border: 1px solid var(--glass-border); }
        
        .wallet-section { margin-top: 20px; padding-top: 15px; border-top: 1px solid var(--glass-border); }
        .wallet-buttons { display: flex; gap: 10px; margin-top: 10px; }
        .wallet-btn {
            flex: 1; padding: 12px; border-radius: 15px; background: rgba(255,255,255,0.1); color: white; border: none; 
            font-weight: bold; cursor: pointer; transition: all 0.3s ease; display: flex; align-items: center; justify-content: center; gap: 8px;
        }
        .wallet-btn:hover { background: rgba(255,255,255,0.15); }
        .wallet-status { margin-top: 10px; font-size: 0.9rem; padding: 10px; background: rgba(0,0,0,0.2); border-radius: 10px; text-align: center; }
        
        .user-stats { background: rgba(106,17,203,0.3); border: 1px solid var(--accent); border-radius: 15px; padding: 15px; margin-bottom: 20px; }
        .user-stats-title { font-size: 1.2rem; text-align: center; margin-bottom: 10px; color: var(--gold); }
        .user-stats-values { display: flex; justify-content: space-around; text-align: center; }
        .user-stat-item { display: flex; flex-direction: column; }
        .user-stat-label { font-size: 0.9rem; opacity: 0.8; }
        .user-stat-value { font-size: 1.3rem; font-weight: bold; color: var(--accent); }
        
        .about-header { text-align: center; margin-bottom: 20px; }
        .about-logo { font-size: 3rem; background: linear-gradient(45deg, var(--primary), var(--secondary)); -webkit-background-clip: text; -webkit-text-fill-color: transparent; margin-bottom: 10px; }
        .about-title { font-size: 1.8rem; margin-bottom: 10px; color: var(--accent); }
        .about-subtitle { font-size: 1.2rem; opacity: 0.8; margin-bottom: 20px; }
        
        .roadmap { margin: 30px 0; }
        .roadmap-title { font-size: 1.5rem; text-align: center; margin-bottom: 20px; color: var(--accent); }
        .roadmap-item { display: flex; margin-bottom: 30px; position: relative; }
        .roadmap-item:before {
            content: ''; position: absolute; top: 0; left: 20px; height: 100%; width: 2px; background: var(--accent); z-index: 1;
        }
        .roadmap-dot {
            width: 40px; height: 40px; border-radius: 50%; background: var(--darker); display: flex; align-items: center; 
            justify-content: center; margin-right: 20px; z-index: 2; position: relative; border: 2px solid var(--accent);
        }
        .roadmap-content { flex: 1; background: var(--glass); padding: 15px; border-radius: 10px; border: 1px solid var(--glass-border); }
        .roadmap-date { font-weight: bold; color: var(--gold); margin-bottom: 5px; }
        .roadmap-description { font-size: 0.9rem; line-height: 1.5; }
        
        .reset-container { margin-top: 30px; padding-top: 20px; border-top: 1px solid var(--glass-border); text-align: center; }
        .reset-warning { color: var(--danger); font-weight: bold; margin-bottom: 15px; }
        
        .item-icon { font-size: 2.5rem; margin-bottom: 10px; }
        .bronze-item { color: var(--bronze); text-shadow: 0 0 10px rgba(205,127,50,0.5); }
        .silver-item { color: var(--silver); text-shadow: 0 0 10px rgba(192,192,192,0.5); }
        .gold-item { color: var(--gold); text-shadow: 0 0 10px rgba(241,196,15,0.5); }
        .item-name { font-weight: bold; margin-bottom: 5px; }
        .item-count { font-size: 1.2rem; font-weight: bold; margin-bottom: 10px; }
        .item-price { font-size: 0.9rem; margin-bottom: 10px; color: var(--gold); }
        .sell-btn {
            width: 100%; padding: 8px; border: none; border-radius: 10px; background: rgba(255,255,255,0.1); color: white; 
            font-weight: bold; cursor: pointer; transition: all 0.3s ease;
        }
        .sell-btn:hover { background: rgba(255,255,255,0.15); }
        
        .tutorial-overlay, .open-chest-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); z-index: 2000; 
            display: flex; align-items: center; justify-content: center; opacity: 0; visibility: hidden; transition: all 0.5s ease;
        }
        .tutorial-overlay.active, .open-chest-overlay.active { opacity: 1; visibility: visible; }
        .tutorial-card, .chest-reward-card {
            background: rgba(30,40,60,0.95); border-radius: 20px; padding: 30px; max-width: 90%; width: 500px; 
            box-shadow: 0 10px 30px rgba(0,0,0,0.5); position: relative;
        }
        .chest-reward-card { width: 350px; text-align: center; }
        .tutorial-step { display: none; }
        .tutorial-step.active { display: block; }
        .tutorial-title { font-size: 1.5rem; text-align: center; margin-bottom: 20px; color: var(--accent); }
        .tutorial-content { font-size: 1rem; line-height: 1.6; margin-bottom: 25px; text-align: center; }
        .tutorial-buttons { display: flex; justify-content: space-between; }
        .tutorial-progress { text-align: center; margin-bottom: 20px; font-size: 0.9rem; opacity: 0.7; }
        
        .reward-icon { font-size: 4rem; margin-bottom: 20px; }
        .reward-title { font-size: 1.8rem; margin-bottom: 10px; }
        .reward-desc { font-size: 1.2rem; margin-bottom: 20px; }
        .reward-value { font-size: 1.5rem; color: var(--gold); font-weight: bold; }
        
        .pulse { animation: pulse 2s infinite; }
        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }
        
        @media (max-width: 600px) {
            .stats, .exchange-rates { grid-template-columns: 1fr; }
            .hashes { font-size: 2.2rem; }
            .coins { font-size: 1.3rem; }
            .nav-btn { padding: 5px 2px; font-size: 0.65rem; width: 12%; }
            .nav-btn i { font-size: 0.9rem; }
            .logo-text { font-size: 1.5rem; }
            .rutcoin-display { font-size: 0.8rem; padding: 4px 10px; }
            .footer-info { bottom: 60px; font-size: 0.65rem; }
            .tutorial-card, .chest-reward-card { padding: 20px; }
            .tutorial-title { font-size: 1.2rem; }
            .roll-container { height: 160px; }
            .roll-item { min-width: 33.33%; }
            .wallet-buttons { flex-direction: column; }
            .feature-grid, .stats-grid, .inventory-container { grid-template-columns: 1fr; }
            .roadmap-item { flex-direction: column; }
            .roadmap-item:before { display: none; }
            .roadmap-dot { margin: 0 auto 10px; }
            .user-stats-values { flex-direction: column; gap: 10px; }
            .inventory-container { grid-template-columns: repeat(auto-fill, minmax(100px, 1fr)); }
        }
    </style>
</head>
<body>
    <canvas id="particles-background"></canvas>
    <div class="notification" id="notification">Улучшение куплено!</div>
    
    <div class="tutorial-overlay" id="tutorialOverlay">
        <div class="tutorial-card">
            <div class="tutorial-step active" id="tutorialStep1">
                <div class="tutorial-title">Добро пожаловать в RUTHASH 2.3.3!</div>
                <div class="tutorial-content">Оптимизированный интерфейс и улучшенная производительность!</div>
                <div class="tutorial-progress">Шаг 1 из 3</div>
                <div class="tutorial-buttons"><button class="btn" id="tutorialNext">Далее</button></div>
            </div>
            <div class="tutorial-step" id="tutorialStep2">
                <div class="tutorial-title">Новые улучшения</div>
                <div class="tutorial-content">Упрощенная система улучшений и оптимизированные вычисления</div>
                <div class="tutorial-progress">Шаг 2 из 3</div>
                <div class="tutorial-buttons">
                    <button class="btn" id="tutorialPrev">Назад</button>
                    <button class="btn" id="tutorialNext2">Далее</button>
                </div>
            </div>
            <div class="tutorial-step" id="tutorialStep3">
                <div class="tutorial-title">Баланс и предметы</div>
                <div class="tutorial-content">Улучшенный алгоритм расчета цен и оптимизированный инвентарь</div>
                <div class="tutorial-progress">Шаг 3 из 3</div>
                <div class="tutorial-buttons">
                    <button class="btn" id="tutorialPrev2">Назад</button>
                    <button class="btn" id="tutorialStart">Начать!</button>
                </div>
            </div>
        </div>
    </div>
    
    <div class="open-chest-overlay" id="openChestOverlay">
        <div class="chest-reward-card" id="chestRewardCard">
            <div class="reward-icon" id="rewardIcon"></div>
            <div class="reward-title" id="rewardTitle">Поздравляем!</div>
            <div class="reward-desc" id="rewardDesc">Вы получили:</div>
            <div class="reward-value" id="rewardValue">0</div>
            <button class="btn" id="closeChestBtn" style="margin-top: 20px;">Закрыть</button>
        </div>
    </div>
    
    <div class="container">
        <header>
            <div class="logo">
                <div class="logo-icon pulse">R</div>
                <h1 class="logo-text">RUTHASH</h1>
            </div>
            <div class="rutcoin-display">
                <i class="fas fa-coins"></i>
                <span id="rutcoinAmount">0.00 RUTHASH</span>
            </div>
        </header>
        
        <div id="upgrades-tab" class="tab-content">
            <div class="dashboard">
                <div class="card">
                    <div class="card-title"><i class="fas fa-rocket"></i> Улучшения майнинга</div>
                    <div class="upgrade-container">
                        <div class="upgrade-item">
                            <div class="upgrade-header">
                                <div class="upgrade-title">Скорость майнинга</div>
                                <div class="upgrade-cost"><i class="fas fa-coins"></i> <span id="miningCost">8.5</span> RUTHASH</div>
                            </div>
                            <div class="upgrade-description">Увеличивает скорость майнинга на 0.5 RUTHASH/c</div>
                            <div class="progress-container"><div class="progress-bar" id="miningProgress" style="width: 0%"></div></div>
                            <div class="upgrade-benefit">
                                <span>Текущая скорость: <span id="currentHashrate">0.5</span> RUTHASH/c</span>
                                <span>Следующий уровень: <span id="nextHashrate">1.0</span> RUTHASH/c</span>
                            </div>
                            <button class="btn btn-upgrade" id="buyMiningBtn">Улучшить</button>
                        </div>
                    </div>
                </div>
                
                <div class="card">
                    <div class="card-title"><i class="fas fa-dice"></i> Улучшение сундуков</div>
                    <div class="luck-container">
                        <div class="upgrade-item luck-item">
                            <div class="upgrade-header">
                                <div class="upgrade-title">Увеличить удачу</div>
                                <div class="upgrade-cost"><i class="fas fa-coins"></i> <span id="luckCost">510 RUTHASH</span></div>
                            </div>
                            <div class="upgrade-description">Увеличивает шанс выпадения более ценных предметов</div>
                            <div class="power-level">
                                <span>Текущий уровень удачи: <span id="currentLuckLevel">1</span></span>
                                <button class="btn btn-luck" id="upgradeLuckBtn">Купить</button>
                            </div>
                        </div>
                        
                        <div class="upgrade-item luck-item">
                            <div class="upgrade-header">
                                <div class="upgrade-title">Увеличить базовую награду</div>
                                <div class="upgrade-cost"><i class="fas fa-coins"></i> <span id="baseRewardCost">382.5 RUTHASH</span></div>
                            </div>
                            <div class="upgrade-description">Повышает минимальную и среднюю награду за сундук</div>
                            <div class="power-level">
                                <span>Текущая базовая награда: <span id="currentBaseReward">x1.0</span></span>
                                <button class="btn btn-luck" id="upgradeRewardBtn">Купить</button>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="card">
                    <div class="card-title"><i class="fas fa-gem"></i> Премиум Ролл</div>
                    <div class="roll-container">
                        <div class="roll-pointer"></div>
                        <div class="roll-items" id="premiumRollItems"></div>
                    </div>
                    <button class="spin-button premium-button" id="premiumSpinButton">
                        <i class="fas fa-dice"></i> Премиум Ролл (5 $RUT)
                    </button>
                    <div class="roll-info">
                        <div class="roll-timer" id="premiumRollTimer">Ролл доступен!</div>
                        <div class="info">Крутите, чтобы получить от 120 до 5000 RUTHASH!</div>
                    </div>
                </div>
            </div>
        </div>
        
        <div id="inventory-tab" class="tab-content">
            <div class="dashboard">
                <div class="card">
                    <div class="card-title"><i class="fas fa-archive"></i> Ваш инвентарь</div>
                    <div class="info">
                        <p>Собранные предметы можно продать за RUTHASH или сохранить для будущих функций.</p>
                        <p>Цены на предметы зависят от их количества у вас - чем больше одинаковых предметов, тем ниже их стоимость.</p>
                    </div>
                    <div class="inventory-container" id="inventoryItems"></div>
                </div>
            </div>
        </div>
        
        <!-- Новая вкладка достижений -->
        <div id="quests-tab" class="tab-content">
            <div class="dashboard">
                <div class="card">
                    <div class="card-title"><i class="fas fa-tasks"></i> Достижения</div>
                    <div class="quest-container" id="questsContainer">
                        <div class="quest-item">
                            <div class="quest-header">
                                <div class="quest-title">Начало пути</div>
                                <div class="quest-reward"><i class="fas fa-coins"></i> 100 RUTHASH</div>
                            </div>
                            <div class="quest-description">Заработайте свои первые 10 RUTHASH</div>
                            <div class="quest-progress">
                                <div class="quest-progress-bar" style="width: 0%"></div>
                            </div>
                            <div class="quest-status">
                                <span>Прогресс: <span id="quest1Progress">0/10</span></span>
                                <button class="btn btn-claim" id="claimQuest1" disabled>Получить</button>
                            </div>
                        </div>
                        
                        <div class="quest-item">
                            <div class="quest-header">
                                <div class="quest-title">Улучшатель</div>
                                <div class="quest-reward"><i class="fas fa-coins"></i> 250 RUTHASH</div>
                            </div>
                            <div class="quest-description">Улучшите скорость майнинга до 2 уровня</div>
                            <div class="quest-progress">
                                <div class="quest-progress-bar" style="width: 0%"></div>
                            </div>
                            <div class="quest-status">
                                <span>Прогресс: <span id="quest2Progress">0/2</span></span>
                                <button class="btn btn-claim" id="claimQuest2" disabled>Получить</button>
                            </div>
                        </div>
                        
                        <div class="quest-item">
                            <div class="quest-header">
                                <div class="quest-title">Коллекционер</div>
                                <div class="quest-reward"><i class="fas fa-coins"></i> 500 RUTHASH</div>
                            </div>
                            <div class="quest-description">Получите 5 предметов в инвентаре</div>
                            <div class="quest-progress">
                                <div class="quest-progress-bar" style="width: 0%"></div>
                            </div>
                            <div class="quest-status">
                                <span>Прогресс: <span id="quest3Progress">0/5</span></span>
                                <button class="btn btn-claim" id="claimQuest3" disabled>Получить</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div id="main-tab" class="tab-content active">
            <div class="dashboard">
                <div class="card">
                    <div class="card-title"><i class="fas fa-coins"></i> Ваш баланс</div>
                    <div class="coins" id="coins">0.00 RUTHASH</div>
                    <div class="roll-container">
                        <div class="roll-pointer"></div>
                        <div class="roll-items" id="rollItems"></div>
                    </div>
                    <button class="spin-button" id="spinButton"><i class="fas fa-dice"></i> Обычный Ролл</button>
                    <div class="roll-info">
                        <div class="roll-timer" id="rollTimer">Ролл доступен!</div>
                        <div class="info">Крутите каждые 3 секунды, чтобы получить сундук с наградами!</div>
                    </div>
                </div>
                
                <div class="card">
                    <div class="card-title"><i class="fas fa-microchip"></i> Майнинг</div>
                    <div class="mining-area">
                        <div class="hashes" id="hashes">0.5 RUTHASH/c</div>
                        <div class="info" style="margin-top: 10px; text-align: center;">
                            <p>Майнинг работает в фоновом режиме</p>
                            <p>Баланс майнинга автоматически добавляется к основному</p>
                        </div>
                    </div>
                </div>
                
                <div class="card">
                    <div class="card-title"><i class="fas fa-chart-line"></i> Статистика</div>
                    <div class="stats">
                        <div class="stat-item">
                            <h3>Всего RUTHASH</h3>
                            <div class="stat-value" id="totalCoins">0.00</div>
                        </div>
                        <div class="stat-item">
                            <h3>Всего $RUT</h3>
                            <div class="stat-value" id="totalRutcoin">0.0000</div>
                        </div>
                        <div class="stat-item">
                            <h3>Уровень улучшений</h3>
                            <div class="stat-value" id="upgradeLevel">1</div>
                        </div>
                        <div class="stat-item">
                            <h3>Роллов</h3>
                            <div class="stat-value" id="rolls">0</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div id="leaderboard-tab" class="tab-content">
            <div class="dashboard">
                <div class="card">
                    <div class="card-title"><i class="fas fa-trophy"></i> Таблица лидеров</div>
                    
                    <div class="user-stats">
                        <div class="user-stats-title">Ваши результаты</div>
                        <div class="user-stats-values">
                            <div class="user-stat-item">
                                <div class="user-stat-label">RUTHASH</div>
                                <div class="user-stat-value" id="userTotalCoins">0</div>
                            </div>
                            <div class="user-stat-item">
                                <div class="user-stat-label">$RUT</div>
                                <div class="user-stat-value" id="userTotalRutcoin">0.00</div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="leaderboard-list" id="leaderboardList">
                        <!-- Leaderboard will be populated by JavaScript -->
                    </div>
                </div>
            </div>
        </div>
        
        <div id="exchange-tab" class="tab-content">
            <div class="dashboard">
                <div class="card">
                    <div class="card-title"><i class="fas fa-exchange-alt"></i> Обмен RUTHASH на $RUT</div>
                    <div class="exchange-container">
                        <div class="balance-info">
                            <p>Ваш баланс: <span id="exchangeBalance">0.00</span> RUTHASH</p>
                            <p>Текущий курс: <span id="exchangeRateValue">0.0000</span> $RUT за 1 RUTHASH</p>
                            <p>Вы получите: <span id="exchangeRate">0.0000</span> $RUT за 1 RUTHASH (после комиссии)</p>
                            <p>Комиссия: <span id="exchangeFeeValue">27%</span></p>
                            <p class="info">Минимальная сумма обмена: 500 RUTHASH</p>
                        </div>
                        <div class="exchange-form">
                            <label for="exchangeAmount">Количество RUTHASH:</label>
                            <input type="number" id="exchangeAmount" min="0" step="0.01" placeholder="Введите количество">
                            <button class="btn btn-exchange" id="exchangeBtn">Обменять</button>
                        </div>
                        <div class="exchange-result">
                            <p>После обмена вы получите: <span id="exchangeResult">0.0000</span> $RUT</p>
                            <p>Комиссия: <span id="exchangeFee">0.00</span> RUTHASH</p>
                        </div>
                        <div class="exchange-rates">
                            <div class="rate-item">
                                <p>Текущий баланс $RUT:</p>
                                <p class="stat-value" id="rutBalance">0.0000</p>
                            </div>
                            <div class="rate-item">
                                <p>Примерная стоимость:</p>
                                <p class="stat-value" id="usdtValue">0.00 USDT</p>
                            </div>
                        </div>
                        <div class="exchange-chart" id="exchangeChart"><canvas id="rateChart"></canvas></div>
                        <div class="info">Внимание: Обмен необратим. $RUT будет начислен на ваш внутренний счет.</div>
                        
                        <div class="wallet-section">
                            <div class="card-title"><i class="fas fa-wallet"></i> Подключение кошелька</div>
                            <div class="wallet-buttons">
                                <button class="wallet-btn" id="connectTrustBtn"><i class="fas fa-wallet"></i> Trust Wallet</button>
                                <button class="wallet-btn" id="connectMetaMaskBtn"><i class="fas fa-wallet"></i> MetaMask</button>
                            </div>
                            <div class="wallet-status" id="walletStatus">Кошелек не подключен</div>
                            <div class="info">
                                <p>Подключите кошелек для вывода средств. Минимальная сумма вывода: 10 $RUT</p>
                                <button class="btn btn-exchange" id="withdrawBtn" disabled>Вывести $RUT</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div id="about-tab" class="tab-content">
            <div class="dashboard">
                <div class="card">
                    <div class="about-header">
                        <div class="about-logo"><i class="fas fa-coins"></i></div>
                        <h1 class="about-title">RUTHASH 2.3.3</h1>
                        <p class="about-subtitle">Оптимизированная платформа для заработка криптовалюты</p>
                    </div>
                    <div class="info">
                        <p>RUTHASH - оптимизированное приложение для получения криптовалюты в Telegram. Версия 2.3.3 приносит улучшения производительности и баланса.</p>
                        <h3 style="margin-top: 20px; color: var(--accent);">Что нового в версии 2.3.3:</h3>
                        <ul>
                            <li>Добавлена вкладка достижений с наградами</li>
                            <li>Уменьшено время ожидания бесплатного ролла до 3 секунд</li>
                            <li>Улучшен интерфейс таблицы лидеров</li>
                            <li>Оптимизирована анимация ролла для лучшей видимости выпадающих предметов</li>
                            <li>Снижены цены на все улучшения на 15%</li>
                            <li>Увеличена частота обновления баланса</li>
                            <li>Исправлены ошибки с выпадением предметов</li>
                            <li>Увеличена волатильность обменного курса</li>
                            <li>Уменьшено количество частиц до 23 для оптимизации</li>
                        </ul>
                    </div>
                    
                    <div class="feature-grid">
                        <div class="feature-card">
                            <div class="feature-icon"><i class="fas fa-bolt"></i></div>
                            <div class="feature-title">Оптимизированный майнинг</div>
                            <div class="feature-description">Улучшенные алгоритмы расчета и более плавная анимация</div>
                        </div>
                        <div class="feature-card">
                            <div class="feature-icon"><i class="fas fa-box-open"></i></div>
                            <div class="feature-title">Компактные сундуки</div>
                            <div class="feature-description">Упрощенная система наград и улучшенная производительность</div>
                        </div>
                        <div class="feature-card">
                            <div class="feature-icon"><i class="fas fa-exchange-alt"></i></div>
                            <div class="feature-title">Эффективный обмен</div>
                            <div class="feature-description">Быстрые операции обмена с минимальными задержками</div>
                        </div>
                        <div class="feature-card">
                            <div class="feature-icon"><i class="fas fa-trophy"></i></div>
                            <div class="feature-title">Легкая таблица лидеров</div>
                            <div class="feature-description">Оптимизированное отображение рейтинга игроков</div>
                        </div>
                    </div>
                    
                    <div class="roadmap">
                        <h3 class="roadmap-title">Дорожная карта проекта</h3>
                        <div class="roadmap-item">
                            <div class="roadmap-dot"><i class="fas fa-rocket"></i></div>
                            <div class="roadmap-content">
                                <div class="roadmap-date">Сентябрь 2025</div>
                                <div class="roadmap-description">Интеграция с NFT и запуск мобильного приложения</div>
                            </div>
                        </div>
                        <div class="roadmap-item">
                            <div class="roadmap-dot"><i class="fas fa-gem"></i></div>
                            <div class="roadmap-content">
                                <div class="roadmap-date">Октябрь 2025</div>
                                <div class="roadmap-description">Добавление PvP режима и турниров</div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="stats-grid">
                        <div class="stat-card"><div class="stat-value" id="totalUsers">48K+</div><div class="stat-label">Пользователей</div></div>
                        <div class="stat-card"><div class="stat-value" id="totalCoinsMined">3.5M</div><div class="stat-label">Намайнено RUTHASH</div></div>
                        <div class="stat-card"><div class="stat-value" id="totalTransactions">92K</div><div class="stat-label">Обменов</div></div>
                        <div class="stat-card"><div class="stat-value" id="maxReward">5000</div><div class="stat-label">Макс. награда</div></div>
                    </div>
                    
                    <div class="reset-container">
                        <div class="reset-warning">⚠️ Внимание: Сброс статистики удалит все ваши данные без возможности восстановления!</div>
                        <button class="btn btn-danger btn-reset" id="resetStatsBtn"><i class="fas fa-trash-alt"></i> Сбросить статистику</button>
                    </div>
                    
                    <a href="https://t.me/RUTHASH_o" class="telegram-btn"><i class="fab fa-telegram"></i> Наш Telegram-канал</a>
                </div>
                <div class="disclaimer">⚠️ Играйте ответственно. RUTHASH не гарантирует доход и не является финансовым советом.</div>
            </div>
        </div>
    </div>

    <div class="footer-info">
        <div class="footer-left">v2.3.3</div>
        <div class="footer-right" id="userIdFooter">ID: загрузка...</div>
    </div>

    <div class="nav-container">
        <button class="nav-btn" data-tab="upgrades-tab"><i class="fas fa-tools"></i><span>Улучш.</span></button>
        <button class="nav-btn" data-tab="inventory-tab"><i class="fas fa-archive"></i><span>Инвентарь</span></button>
        <button class="nav-btn" data-tab="quests-tab"><i class="fas fa-tasks"></i><span>Достижения</span></button>
        <button class="nav-btn active" data-tab="main-tab"><i class="fas fa-home"></i><span>Главная</span></button>
        <button class="nav-btn" data-tab="leaderboard-tab"><i class="fas fa-trophy"></i><span>Лидеры</span></button>
        <button class="nav-btn" data-tab="exchange-tab"><i class="fas fa-exchange-alt"></i><span>Вывод</span></button>
        <button class="nav-btn" data-tab="about-tab"><i class="fas fa-info-circle"></i><span>О проекте</span></button>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
        // Конфигурация игры
        const config = {
            saveInterval: 15000,
            userId: null,
            baseHashes: 0.5,
            exchangeFee: 0.27,
            usdtRate: 0.1,
            miningUpgrades: Array(10).fill().map((_, i) => ({
                level: i+1, 
                bonus: 0.5*(i+1), 
                cost: Math.round(10 * Math.pow(2, i) * 0.85) // Уменьшены на 15%
            })),
            luckUpgrades: Array(10).fill().map((_, i) => ({
                level: i+1, 
                bonus: 0.01*(i+1), 
                cost: Math.round(600 * Math.pow(1.5, i) * 0.85) // Уменьшены на 15%
            })),
            rewardUpgrades: Array(10).fill().map((_, i) => ({
                level: i+1, 
                bonus: 1+0.2*i, 
                cost: Math.round(450 * Math.pow(1.65, i) * 0.85) // Уменьшены на 15%
            })),
            rollSpinDuration: 3000,
            rollSpinInterval: 3000, // Уменьшено до 3 секунд
            minWithdrawal: 10,
            minExchange: 500,
            minExchangeRate: 0.004,
            maxExchangeRate: 0.015,
            exchangeRateInterval: 5000, // Увеличена частота обновления
            exchangeRateGrowthFactor: 0.0001,
            exchangeVolatility: 0.375, // Увеличена волатильность
            maxBonusHashrate: 75,
            particleCount: 23 // Уменьшено количество частиц
        };

        // Состояние игры
        const state = {
            coins: 0,
            rutcoin: 0,
            miningHashes: 0,
            miningStartTime: Date.now(),
            exchangeRate: 0.008,
            exchangeHistory: [],
            userData: {
                totalCoins: 0,
                totalRutcoin: 0,
                totalRolls: 0,
                miningLevel: 1,
                luckLevel: 1,
                rewardLevel: 1,
                hashBonus: 0,
                walletConnected: false,
                walletAddress: null,
                lastDailyBonus: 0,
                tutorialCompleted: false,
                leaderboardPosition: 0,
                items: { bronze: 0, silver: 0, gold: 0 },
                quests: {
                    quest1: { completed: false, progress: 0, target: 10 },
                    quest2: { completed: false, progress: 0, target: 2 },
                    quest3: { completed: false, progress: 0, target: 5 }
                }
            },
            leaderboardData: [],
            elements: {}
        };

        // Основные функции
        const initTelegram = () => {
            try {
                Telegram.WebApp.ready();
                Telegram.WebApp.expand();
                const user = Telegram.WebApp.initDataUnsafe.user;
                state.userId = user?.id || `anon_${Math.floor(Math.random()*1000000)}`;
                state.elements.userIdFooter.textContent = `ID: ${user?.id ? user.id : 'анонимный'}`;
                loadUserData();
            } catch (e) {
                state.userId = `anon_${Math.floor(Math.random()*1000000)}`;
                state.elements.userIdFooter.textContent = 'ID: анонимный';
            }
        };

        const saveUserData = () => {
            if (state.userId) {
                localStorage.setItem(`ruthash_user_${state.userId}`, JSON.stringify(state.userData));
            }
        };

        const loadUserData = () => {
            if (!state.userId) return;
            
            try {
                const savedData = localStorage.getItem(`ruthash_user_${state.userId}`);
                if (savedData) {
                    state.userData = JSON.parse(savedData);
                    updateDisplay();
                    updateMiningLevel();
                    updateLuckUpgrades();
                    updateExchangeUI();
                    updateInventory();
                    updateQuests();
                    generateLeaderboard();
                    
                    if (!state.userData.tutorialCompleted) {
                        setTimeout(() => state.elements.tutorialOverlay.classList.add('active'), 1000);
                    }
                } else {
                    setTimeout(() => state.elements.tutorialOverlay.classList.add('active'), 1000);
                }
            } catch (e) {
                console.error('Ошибка загрузки:', e);
            }
            
            updateMiningLevel();
            initRolls();
            startMining();
            startExchangeRateChange();
            initExchangeChart();
        };

        const formatNumber = num => num >= 1e6 ? (num/1e6).toFixed(1)+'M' : num >= 1e3 ? (num/1e3).toFixed(1)+'K' : num.toFixed(2);

        const animateValue = (element, start, end, duration) => {
            let startTimestamp = null;
            const step = timestamp => {
                if (!startTimestamp) startTimestamp = timestamp;
                const progress = Math.min((timestamp - startTimestamp) / duration, 1);
                element.textContent = formatNumber(start + progress * (end - start));
                progress < 1 && requestAnimationFrame(step);
            };
            requestAnimationFrame(step);
        };

        const updateDisplay = () => {
            const coinsEl = state.elements.coins;
            const currentCoins = parseFloat(coinsEl.textContent) || 0;
            Math.abs(currentCoins - state.userData.totalCoins) > 0.01 && 
                animateValue(coinsEl, currentCoins, state.userData.totalCoins, 500);
            
            state.elements.rutcoinAmount.textContent = formatNumber(state.userData.totalCoins) + ' RUTHASH';
            state.elements.totalCoins.textContent = formatNumber(state.userData.totalCoins);
            state.elements.userTotalCoins.textContent = formatNumber(state.userData.totalCoins);
            
            const rutcoinEl = state.elements.totalRutcoin;
            const currentRutcoin = parseFloat(rutcoinEl.textContent) || 0;
            Math.abs(currentRutcoin - state.userData.totalRutcoin) > 0.0001 && 
                animateValue(rutcoinEl, currentRutcoin, state.userData.totalRutcoin, 500);
            
            state.elements.userTotalRutcoin.textContent = state.userData.totalRutcoin.toFixed(2);
            state.elements.rolls.textContent = state.userData.totalRolls;
            state.elements.upgradeLevel.textContent = state.userData.miningLevel;
            
            const now = Date.now();
            const nextRoll = state.lastRoll + config.rollSpinInterval;
            const rollTimer = state.elements.rollTimer;
            const spinButton = state.elements.spinButton;
            
            if (now < nextRoll) {
                rollTimer.textContent = `Доступно через: ${Math.floor((nextRoll-now)/1000)}с`;
                spinButton.disabled = true;
                spinButton.classList.add('btn-disabled');
            } else {
                rollTimer.textContent = 'Ролл доступен!';
                spinButton.disabled = false;
                spinButton.classList.remove('btn-disabled');
            }
            
            const premiumBtn = state.elements.premiumSpinButton;
            premiumBtn.disabled = state.userData.totalRutcoin < 5;
            premiumBtn.classList.toggle('btn-disabled', premiumBtn.disabled);
        };

        const updateMiningLevel = () => {
            const level = state.userData.miningLevel;
            const baseHashrate = config.miningUpgrades.slice(0, level).reduce((sum, u) => sum + u.bonus, config.baseHashes);
            const bonusMultiplier = 1 + (state.userData.hashBonus / 100);
            const totalHashrate = Math.min(config.maxBonusHashrate, baseHashrate * bonusMultiplier);
            
            state.elements.hashes.textContent = totalHashrate.toFixed(1) + ' RUTHASH/c';
            state.elements.currentHashrate.textContent = baseHashrate.toFixed(1);
            state.elements.miningProgress.style.width = `${(level/10)*100}%`;
            
            const btn = state.elements.buyMiningBtn;
            if (level < 10) {
                const next = config.miningUpgrades[level];
                state.elements.miningCost.textContent = next.cost;
                // Исправлено отображение следующего уровня
                state.elements.nextHashrate.textContent = (baseHashrate + next.bonus).toFixed(1);
                btn.disabled = state.userData.totalCoins < next.cost;
            } else {
                state.elements.miningCost.textContent = "Макс";
                state.elements.nextHashrate.textContent = "5.0";
                btn.disabled = true;
                btn.textContent = 'Максимальный уровень';
            }
            btn.classList.toggle('btn-disabled', btn.disabled);
        };

        const updateLuckUpgrades = () => {
            const luckLevel = state.userData.luckLevel;
            const rewardLevel = state.userData.rewardLevel;
            
            state.elements.currentLuckLevel.textContent = luckLevel;
            state.elements.currentBaseReward.textContent = 'x' + config.rewardUpgrades[rewardLevel-1].bonus.toFixed(1);
            state.elements.luckCost.textContent = config.luckUpgrades[luckLevel-1].cost + ' RUTHASH';
            state.elements.baseRewardCost.textContent = config.rewardUpgrades[rewardLevel-1].cost + ' RUTHASH';
            
            const luckBtn = state.elements.upgradeLuckBtn;
            const rewardBtn = state.elements.upgradeRewardBtn;
            
            luckBtn.disabled = luckLevel >= 10 || state.userData.totalCoins < config.luckUpgrades[luckLevel-1].cost;
            luckBtn.classList.toggle('btn-disabled', luckBtn.disabled);
            luckBtn.textContent = luckLevel >= 10 ? 'Макс. уровень' : 'Купить';
            
            rewardBtn.disabled = rewardLevel >= 10 || state.userData.totalCoins < config.rewardUpgrades[rewardLevel-1].cost;
            rewardBtn.classList.toggle('btn-disabled', rewardBtn.disabled);
            rewardBtn.textContent = rewardLevel >= 10 ? 'Макс. уровень' : 'Купить';
        };

        const showNotification = message => {
            const notification = state.elements.notification;
            notification.textContent = message;
            notification.style.display = 'block';
            setTimeout(() => notification.style.display = 'none', 3000);
        };

        const setupTabNavigation = () => {
            document.querySelectorAll('.nav-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    const tabId = btn.dataset.tab;
                    document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
                    document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
                    
                    document.getElementById(tabId).classList.add('active');
                    btn.classList.add('active');
                    
                    if (tabId === 'exchange-tab') updateExchangeUI();
                    else if (tabId === 'inventory-tab') updateInventory();
                    else if (tabId === 'upgrades-tab') updateLuckUpgrades();
                    else if (tabId === 'about-tab') updateAboutPage();
                    else if (tabId === 'leaderboard-tab') generateLeaderboard();
                    else if (tabId === 'quests-tab') updateQuests();
                });
            });
        };

        const initRolls = () => {
            const chests = [
                {id:0, name:"Обычный", chance:0.50, color:"#6c7a89", icon:"fa-box"},
                {id:1, name:"Необычный", chance:0.30, color:"#56ab2f", icon:"fa-box-open"},
                {id:2, name:"Редкий", chance:0.10, color:"#2193b0", icon:"fa-gem"},
                {id:3, name:"Суперредкий", chance:0.075, color:"#8e2de2", icon:"fa-crown"},
                {id:4, name:"Мифический", chance:0.025, color:"#f12711", icon:"fa-dragon"}
            ];
            
            // Создаем закольцованный ролл с дублированием элементов
            state.elements.rollItems.innerHTML = [
                ...chests.map(c => `
                    <div class="roll-item">
                        <div class="chest">
                            <i class="fas ${c.icon} roll-item-icon" style="color:${c.color}"></i>
                            <div class="roll-item-name">${c.name}</div>
                            <div class="roll-item-desc">Шанс: ${(c.chance*100).toFixed(1)}%</div>
                        </div>
                    </div>
                `),
                ...chests.map(c => `
                    <div class="roll-item">
                        <div class="chest">
                            <i class="fas ${c.icon} roll-item-icon" style="color:${c.color}"></i>
                            <div class="roll-item-name">${c.name}</div>
                            <div class="roll-item-desc">Шанс: ${(c.chance*100).toFixed(1)}%</div>
                        </div>
                    </div>
                `),
                ...chests.map(c => `
                    <div class="roll-item">
                        <div class="chest">
                            <i class="fas ${c.icon} roll-item-icon" style="color:${c.color}"></i>
                            <div class="roll-item-name">${c.name}</div>
                            <div class="roll-item-desc">Шанс: ${(c.chance*100).toFixed(1)}%</div>
                        </div>
                    </div>
                `)
            ].join('');
            
            const prizes = [120,240,360,480,600,720,840,1200,1500,1800,2200,2600,3000,3500,4000,4500,5000];
            state.elements.premiumRollItems.innerHTML = prizes.map(p => `
                <div class="roll-item">
                    <i class="fas fa-coins roll-item-icon" style="color:#f1c40f"></i>
                    <div class="roll-item-name">${p} RUTHASH</div>
                    <div class="roll-item-desc">Премиум награда</div>
                </div>
            `).join('');
        };

        const spinRoll = isPremium => {
            if (isPremium && state.userData.totalRutcoin < 5) return showNotification("Недостаточно $RUT!");
            
            const now = Date.now();
            if (!isPremium && now < state.lastRoll + config.rollSpinInterval) 
                return showNotification("Ролл будет доступен позже!");
            
            const rollId = isPremium ? 'premiumRollItems' : 'rollItems';
            const roll = document.getElementById(rollId);
            const spinButton = isPremium ? state.elements.premiumSpinButton : state.elements.spinButton;
            
            spinButton.disabled = true;
            spinButton.classList.add('btn-disabled');
            
            const itemCount = isPremium ? 17 : 15; // 15 для обычного ролла (3 копии по 5)
            const targetIndex = Math.floor(Math.random() * (isPremium ? 17 : 5)); // Для обычного - 5 вариантов
            const spins = 2 + Math.floor(Math.random() * 3);
            
            // Для обычного ролла - добавляем смещение для середины копии
            const scrollDistance = isPremium ? 
                spins * 100 + (targetIndex * 100 / 17) : 
                spins * 100 + (5 + targetIndex) * (100 / 15) * 3;
            
            roll.style.transition = `transform ${config.rollSpinDuration}ms cubic-bezier(0.34,1.56,0.64,1)`;
            roll.style.transform = `translateX(-${scrollDistance}%)`;
            
            setTimeout(() => {
                if (isPremium) {
                    const reward = prizes[targetIndex];
                    state.userData.totalCoins += reward;
                    state.userData.totalRutcoin -= 5;
                    showNotification(`Вы выиграли ${reward} RUTHASH!`);
                } else {
                    state.lastRoll = now;
                    state.userData.totalRolls++;
                    openChest(targetIndex);
                }
                
                spinButton.disabled = false;
                spinButton.classList.remove('btn-disabled');
                updateDisplay();
                saveUserData();
            }, config.rollSpinDuration);
        };

        const openChest = chestId => {
            const rewards = {
                0: { rut: [5,15,25,35], items: [{type:"bronze",amount:1,chance:0.15},{type:"bronze",amount:2,chance:0.05}], rutChance:0.80 },
                1: { rut: [50,100,150,350], items: [{type:"bronze",amount:2,chance:0.20},{type:"silver",amount:1,chance:0.10}], rutChance:0.70 },
                2: { rut: [400,500,700,750], items: [{type:"silver",amount:2,chance:0.25},{type:"gold",amount:0.25,chance:0.15}], rutChance:0.60 },
                3: { rut: [1000,1250,1750], items: [{type:"bronze",amount:2,chance:0.10},{type:"silver",amount:1,chance:0.20},{type:"gold",amount:0.5,chance:0.20}], rutChance:0.50 },
                4: { rut: [2500], items: [{type:"gold",amount:0.75,chance:0.60}], rutChance:0.40 }
            };
            
            const chest = rewards[chestId];
            const multiplier = config.rewardUpgrades[state.userData.rewardLevel-1].bonus;
            const luckBonus = config.luckUpgrades[state.userData.luckLevel-1].bonus;
            
            let rewardType = 'rut', rewardValue = 0;
            
            if (Math.random() < chest.rutChance) {
                rewardValue = Math.floor(chest.rut[Math.floor(Math.random()*chest.rut.length)] * multiplier);
                state.userData.totalCoins += rewardValue;
            } else {
                const totalChance = chest.items.reduce((sum, i) => sum + i.chance, 0);
                let random = Math.random() * totalChance;
                let selected = chest.items.find(i => (random -= i.chance) < 0);
                
                if (selected) {
                    if (Math.random() < luckBonus) {
                        if (selected.type === "bronze" && Math.random() < 0.5) {
                            selected.type = "silver";
                            selected.amount *= 0.8;
                        } else if (selected.type === "silver" && Math.random() < 0.3) {
                            selected.type = "gold";
                            selected.amount *= 0.6;
                        } else {
                            selected.amount *= 1.2;
                        }
                    }
                    rewardType = selected.type;
                    rewardValue = selected.amount;
                    state.userData.items[rewardType] += rewardValue;
                    updateInventory();
                    
                    // Обновляем прогресс квеста коллекционера
                    state.userData.quests.quest3.progress = 
                        state.userData.items.bronze + state.userData.items.silver + state.userData.items.gold;
                    updateQuests();
                }
            }
            
            const icons = { rut: 'fa-coins', bronze: 'fa-coins', silver: 'fa-coins', gold: 'fa-crown' };
            const colors = { rut: '#f1c40f', bronze: '#cd7f32', silver: '#c0c0c0', gold: '#f1c40f' };
            const names = { rut: 'Рутхеши!', bronze: 'Бронзовый слиток', silver: 'Серебрянный слиток', gold: 'Золотой слиток' };
            
            state.elements.rewardIcon.className = `reward-icon fas ${icons[rewardType]}`;
            state.elements.rewardIcon.style.color = colors[rewardType];
            state.elements.rewardTitle.textContent = names[rewardType];
            state.elements.rewardValue.textContent = rewardValue + (rewardType === 'gold' ? '' : ' x');
            
            state.elements.openChestOverlay.classList.add('active');
            showNotification(`Вы получили ${chests[chestId].name} сундук!`);
        };

        const updateInventory = () => {
            const items = Object.entries(state.userData.items).filter(([_,v]) => v > 0);
            const prices = { bronze: 500, silver: 2000, gold: 15000 };
            
            state.elements.inventoryItems.innerHTML = items.map(([type, amount]) => {
                const price = Math.floor(prices[type] * (1 - 0.25 * (amount / (amount + 10))));
                return `
                    <div class="inventory-item">
                        <div class="item-icon ${type}-item"><i class="fas ${type==='gold'?'fa-crown':'fa-coins'}"></i></div>
                        <div class="item-name">${type==='bronze'?'Бронзовый':type==='silver'?'Серебрянный':'Золотой'} слиток</div>
                        <div class="item-count">${formatNumber(amount)}</div>
                        <div class="item-price">${formatNumber(price)} RUTHASH за 1</div>
                        <button class="sell-btn" data-type="${type}" data-price="${price}">Продать все</button>
                    </div>
                `;
            }).join('');
            
            document.querySelectorAll('.sell-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const type = this.dataset.type;
                    const price = parseFloat(this.dataset.price);
                    const amount = state.userData.items[type];
                    const total = amount * price;
                    
                    state.userData.totalCoins += total;
                    state.userData.items[type] = 0;
                    
                    updateDisplay();
                    updateInventory();
                    showNotification(`Продано ${amount} слитков за ${total} RUTHASH!`);
                    saveUserData();
                });
            });
        };

        const updateExchangeUI = () => {
            const amount = parseFloat(state.elements.exchangeAmount.value) || 0;
            const rutAmount = amount * state.exchangeRate * (1 - config.exchangeFee);
            const feeAmount = amount * state.exchangeRate * config.exchangeFee;
            
            state.elements.exchangeBalance.textContent = formatNumber(state.userData.totalCoins);
            state.elements.rutBalance.textContent = formatNumber(state.userData.totalRutcoin);
            state.elements.usdtValue.textContent = formatNumber(state.userData.totalRutcoin * config.usdtRate) + ' USDT';
            state.elements.exchangeRateValue.textContent = state.exchangeRate.toFixed(4);
            state.elements.exchangeRate.textContent = (state.exchangeRate * (1 - config.exchangeFee)).toFixed(4);
            state.elements.exchangeResult.textContent = rutAmount.toFixed(4);
            state.elements.exchangeFee.textContent = feeAmount.toFixed(2);
            
            const walletStatus = state.elements.walletStatus;
            const withdrawBtn = state.elements.withdrawBtn;
            
            if (state.userData.walletConnected) {
                walletStatus.textContent = `Кошелек подключен: ${state.userData.walletAddress.substring(0,6)}...${state.userData.walletAddress.substring(38)}`;
                walletStatus.style.color = '#2ecc71';
                withdrawBtn.disabled = state.userData.totalRutcoin < config.minWithdrawal;
            } else {
                walletStatus.textContent = 'Кошелек не подключен';
                walletStatus.style.color = '#ff416c';
                withdrawBtn.disabled = true;
            }
            withdrawBtn.classList.toggle('btn-disabled', withdrawBtn.disabled);
            
            updateExchangeChart();
        };

        const exchangeTokens = () => {
            const amount = parseFloat(state.elements.exchangeAmount.value);
            if (isNaN(amount) || amount <= 0) return showNotification("Введите корректную сумму");
            if (amount < config.minExchange) return showNotification(`Минимум: ${config.minExchange} RUTHASH`);
            if (amount > state.userData.totalCoins) return showNotification("Недостаточно RUTHASH");
            
            const rutAmount = amount * state.exchangeRate * (1 - config.exchangeFee);
            state.userData.totalCoins -= amount;
            state.userData.totalRutcoin += rutAmount;
            
            state.exchangeRate = Math.min(config.maxExchangeRate, state.exchangeRate + Math.min(0.0005, Math.floor(amount/100)*config.exchangeRateGrowthFactor));
            state.exchangeHistory.push(state.exchangeRate);
            state.exchangeHistory.length > 20 && state.exchangeHistory.shift();
            
            state.elements.exchangeAmount.value = '';
            showNotification(`Обменено! Получено ${rutAmount.toFixed(4)} $RUT`);
            saveUserData();
            updateExchangeUI();
        };

        const startMining = () => {
            state.miningStartTime = Date.now();
            const miningLoop = () => {
                const now = Date.now();
                const elapsed = (now - state.miningStartTime) / 1000;
                const base = config.miningUpgrades.slice(0, state.userData.miningLevel).reduce((s,u) => s + u.bonus, config.baseHashes);
                const bonus = 1 + (state.userData.hashBonus / 100);
                const hashrate = Math.min(config.maxBonusHashrate, base * bonus);
                
                state.miningHashes += hashrate * 0.1;
                state.userData.totalCoins += hashrate * 0.1;
                
                state.elements.hashes.textContent = hashrate.toFixed(1) + ' RUTHASH/c';
                requestAnimationFrame(miningLoop);
                
                // Обновляем прогресс квеста
                if (state.userData.totalCoins > state.userData.quests.quest1.progress) {
                    state.userData.quests.quest1.progress = Math.min(state.userData.totalCoins, state.userData.quests.quest1.target);
                    updateQuests();
                }
            };
            miningLoop();
        };

        const startExchangeRateChange = () => {
            setInterval(() => {
                const change = (Math.random() * config.exchangeVolatility * 2 - config.exchangeVolatility);
                state.exchangeRate = Math.max(config.minExchangeRate, Math.min(config.maxExchangeRate, state.exchangeRate * (1 + change)));
                state.exchangeHistory.push(state.exchangeRate);
                state.exchangeHistory.length > 20 && state.exchangeHistory.shift();
                updateExchangeUI();
            }, config.exchangeRateInterval);
        };

        const initExchangeChart = () => {
            const ctx = state.elements.rateChart.getContext('2d');
            state.rateChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: Array(20).fill(''),
                    datasets: [{
                        data: state.exchangeHistory,
                        borderColor: '#2ecc71',
                        backgroundColor: 'rgba(46,204,113,0.1)',
                        borderWidth: 2,
                        tension: 0.3,
                        fill: true
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: { beginAtZero: false, grid: { color: 'rgba(255,255,255,0.1)' }, ticks: { color: 'rgba(255,255,255,0.7)' } },
                        x: { display: false }
                    },
                    plugins: { legend: { display: false } }
                }
            });
        };

        const updateExchangeChart = () => {
            state.rateChart && (state.rateChart.data.datasets[0].data = state.exchangeHistory) && state.rateChart.update();
        };

        const generateLeaderboard = () => {
            if (!state.leaderboardData.length) {
                const names = ["Alex","Max","Anna","Sergey","Dmitry","Olga","Ivan","Elena","Pavel","Maria"];
                state.leaderboardData = names.map((name, i) => ({
                    name, 
                    rutcoin: Math.floor(Math.random()*5000)/100 + 1,
                    coins: Math.floor(Math.random()*10000) + 1000,
                    bonus: i < 3 ? 100 - i*25 : 0
                })).sort((a,b) => b.rutcoin - a.rutcoin);
                state.userData.leaderboardPosition = Math.floor(Math.random()*10) + 1;
            }
            
            state.elements.leaderboardList.innerHTML = state.leaderboardData.map((p, i) => `
                <div class="leaderboard-item">
                    <div class="leaderboard-rank ${i===0?'rank-1':i===1?'rank-2':i===2?'rank-3':''}">${i+1}</div>
                    <div class="leaderboard-info">
                        <div class="leaderboard-name">${p.name}</div>
                        <div class="leaderboard-value">${p.rutcoin.toFixed(2)} $RUT</div>
                        <div class="leaderboard-hash">${formatNumber(p.coins)} RUTHASH</div>
                        <div class="leaderboard-bonus">${i<3?`Бонус: +${p.bonus}%`:'Без бонуса'}</div>
                    </div>
                </div>
            `).join('');
        };

        const initParticles = () => {
            const canvas = state.elements.particlesBackground;
            const ctx = canvas.getContext('2d');
            canvas.width = window.innerWidth;
            canvas.height = window.innerHeight;
            
            const particles = Array(config.particleCount).fill().map(() => ({
                x: Math.random() * canvas.width,
                y: Math.random() * canvas.height,
                radius: Math.random() * 2 + 0.5,
                speed: Math.random() * 0.5 + 0.1,
                direction: Math.random() * Math.PI * 2,
                color: `rgba(106,17,203,${Math.random()*0.5+0.1})`
            }));
            
            const draw = () => {
                ctx.clearRect(0, 0, canvas.width, canvas.height);
                particles.forEach(p => {
                    p.x += Math.cos(p.direction) * p.speed;
                    p.y += Math.sin(p.direction) * p.speed;
                    
                    if (p.x < 0) p.x = canvas.width;
                    if (p.x > canvas.width) p.x = 0;
                    if (p.y < 0) p.y = canvas.height;
                    if (p.y > canvas.height) p.y = 0;
                    
                    ctx.beginPath();
                    ctx.arc(p.x, p.y, p.radius, 0, Math.PI * 2);
                    ctx.fillStyle = p.color;
                    ctx.fill();
                });
                requestAnimationFrame(draw);
            };
            draw();
            
            window.addEventListener('resize', () => {
                canvas.width = window.innerWidth;
                canvas.height = window.innerHeight;
            });
        };

        const updateQuests = () => {
            // Квест 1: Заработать 10 RUTHASH
            const quest1 = state.userData.quests.quest1;
            const quest1ProgressBar = document.querySelector('#quest1ProgressBar');
            const quest1ProgressText = document.querySelector('#quest1Progress');
            const quest1Btn = document.querySelector('#claimQuest1');
            
            const progress1 = Math.min(100, (quest1.progress / quest1.target) * 100);
            if (quest1ProgressBar) quest1ProgressBar.style.width = `${progress1}%`;
            if (quest1ProgressText) quest1ProgressText.textContent = `${Math.min(quest1.progress, quest1.target)}/${quest1.target}`;
            
            quest1Btn.disabled = quest1.completed || quest1.progress < quest1.target;
            quest1Btn.classList.toggle('btn-disabled', quest1Btn.disabled);
            if (quest1.completed) quest1Btn.textContent = 'Получено';
            
            // Квест 2: Улучшить майнинг до 2 уровня
            const quest2 = state.userData.quests.quest2;
            const quest2ProgressBar = document.querySelector('#quest2ProgressBar');
            const quest2ProgressText = document.querySelector('#quest2Progress');
            const quest2Btn = document.querySelector('#claimQuest2');
            
            quest2.progress = state.userData.miningLevel;
            const progress2 = Math.min(100, (quest2.progress / quest2.target) * 100);
            if (quest2ProgressBar) quest2ProgressBar.style.width = `${progress2}%`;
            if (quest2ProgressText) quest2ProgressText.textContent = `${quest2.progress}/${quest2.target}`;
            
            quest2Btn.disabled = quest2.completed || quest2.progress < quest2.target;
            quest2Btn.classList.toggle('btn-disabled', quest2Btn.disabled);
            if (quest2.completed) quest2Btn.textContent = 'Получено';
            
            // Квест 3: Собрать 5 предметов
            const quest3 = state.userData.quests.quest3;
            const quest3ProgressBar = document.querySelector('#quest3ProgressBar');
            const quest3ProgressText = document.querySelector('#quest3Progress');
            const quest3Btn = document.querySelector('#claimQuest3');
            
            const progress3 = Math.min(100, (quest3.progress / quest3.target) * 100);
            if (quest3ProgressBar) quest3ProgressBar.style.width = `${progress3}%`;
            if (quest3ProgressText) quest3ProgressText.textContent = `${quest3.progress}/${quest3.target}`;
            
            quest3Btn.disabled = quest3.completed || quest3.progress < quest3.target;
            quest3Btn.classList.toggle('btn-disabled', quest3Btn.disabled);
            if (quest3.completed) quest3Btn.textContent = 'Получено';
        };

        const claimQuest = (questId) => {
            const quest = state.userData.quests[questId];
            if (!quest || quest.completed || quest.progress < quest.target) return;
            
            let reward = 0;
            switch(questId) {
                case 'quest1': reward = 100; break;
                case 'quest2': reward = 250; break;
                case 'quest3': reward = 500; break;
            }
            
            state.userData.totalCoins += reward;
            quest.completed = true;
            
            updateDisplay();
            updateQuests();
            showNotification(`Получено ${reward} RUTHASH за достижение!`);
            saveUserData();
        };

        const init = () => {
            // Инициализация элементов
            state.elements = {
                notification: document.getElementById('notification'),
                tutorialOverlay: document.getElementById('tutorialOverlay'),
                openChestOverlay: document.getElementById('openChestOverlay'),
                chestRewardCard: document.getElementById('chestRewardCard'),
                rewardIcon: document.getElementById('rewardIcon'),
                rewardTitle: document.getElementById('rewardTitle'),
                rewardDesc: document.getElementById('rewardDesc'),
                rewardValue: document.getElementById('rewardValue'),
                closeChestBtn: document.getElementById('closeChestBtn'),
                rutcoinAmount: document.getElementById('rutcoinAmount'),
                coins: document.getElementById('coins'),
                totalCoins: document.getElementById('totalCoins'),
                userTotalCoins: document.getElementById('userTotalCoins'),
                totalRutcoin: document.getElementById('totalRutcoin'),
                userTotalRutcoin: document.getElementById('userTotalRutcoin'),
                rolls: document.getElementById('rolls'),
                upgradeLevel: document.getElementById('upgradeLevel'),
                hashes: document.getElementById('hashes'),
                miningCost: document.getElementById('miningCost'),
                currentHashrate: document.getElementById('currentHashrate'),
                nextHashrate: document.getElementById('nextHashrate'),
                miningProgress: document.getElementById('miningProgress'),
                buyMiningBtn: document.getElementById('buyMiningBtn'),
                currentLuckLevel: document.getElementById('currentLuckLevel'),
                luckCost: document.getElementById('luckCost'),
                upgradeLuckBtn: document.getElementById('upgradeLuckBtn'),
                currentBaseReward: document.getElementById('currentBaseReward'),
                baseRewardCost: document.getElementById('baseRewardCost'),
                upgradeRewardBtn: document.getElementById('upgradeRewardBtn'),
                premiumRollItems: document.getElementById('premiumRollItems'),
                premiumSpinButton: document.getElementById('premiumSpinButton'),
                premiumRollTimer: document.getElementById('premiumRollTimer'),
                rollItems: document.getElementById('rollItems'),
                spinButton: document.getElementById('spinButton'),
                rollTimer: document.getElementById('rollTimer'),
                inventoryItems: document.getElementById('inventoryItems'),
                leaderboardList: document.getElementById('leaderboardList'),
                exchangeBalance: document.getElementById('exchangeBalance'),
                exchangeRateValue: document.getElementById('exchangeRateValue'),
                exchangeRate: document.getElementById('exchangeRate'),
                exchangeFeeValue: document.getElementById('exchangeFeeValue'),
                exchangeAmount: document.getElementById('exchangeAmount'),
                exchangeBtn: document.getElementById('exchangeBtn'),
                exchangeResult: document.getElementById('exchangeResult'),
                exchangeFee: document.getElementById('exchangeFee'),
                rutBalance: document.getElementById('rutBalance'),
                usdtValue: document.getElementById('usdtValue'),
                rateChart: document.getElementById('rateChart'),
                connectTrustBtn: document.getElementById('connectTrustBtn'),
                connectMetaMaskBtn: document.getElementById('connectMetaMaskBtn'),
                walletStatus: document.getElementById('walletStatus'),
                withdrawBtn: document.getElementById('withdrawBtn'),
                totalUsers: document.getElementById('totalUsers'),
                totalCoinsMined: document.getElementById('totalCoinsMined'),
                totalTransactions: document.getElementById('totalTransactions'),
                maxReward: document.getElementById('maxReward'),
                resetStatsBtn: document.getElementById('resetStatsBtn'),
                userIdFooter: document.getElementById('userIdFooter'),
                particlesBackground: document.getElementById('particles-background'),
                claimQuest1: document.getElementById('claimQuest1'),
                claimQuest2: document.getElementById('claimQuest2'),
                claimQuest3: document.getElementById('claimQuest3'),
                quest1ProgressBar: document.getElementById('quest1ProgressBar'),
                quest1Progress: document.getElementById('quest1Progress'),
                quest2ProgressBar: document.getElementById('quest2ProgressBar'),
                quest2Progress: document.getElementById('quest2Progress'),
                quest3ProgressBar: document.getElementById('quest3ProgressBar'),
                quest3Progress: document.getElementById('quest3Progress')
            };
            
            // Инициализация приложения
            initTelegram();
            initParticles();
            setupTabNavigation();
            initRolls();
            
            // Назначение обработчиков
            state.elements.spinButton.addEventListener('click', () => spinRoll(false));
            state.elements.premiumSpinButton.addEventListener('click', () => spinRoll(true));
            state.elements.buyMiningBtn.addEventListener('click', () => {
                const level = state.userData.miningLevel;
                if (level < 10 && state.userData.totalCoins >= config.miningUpgrades[level].cost) {
                    state.userData.totalCoins -= config.miningUpgrades[level].cost;
                    state.userData.miningLevel++;
                    updateDisplay();
                    updateMiningLevel();
                    showNotification(`Уровень ${level+1} куплен!`);
                    saveUserData();
                    
                    // Обновляем прогресс квеста
                    state.userData.quests.quest2.progress = state.userData.miningLevel;
                    updateQuests();
                }
            });
            state.elements.upgradeLuckBtn.addEventListener('click', () => {
                const level = state.userData.luckLevel;
                if (level < 10 && state.userData.totalCoins >= config.luckUpgrades[level-1].cost) {
                    state.userData.totalCoins -= config.luckUpgrades[level-1].cost;
                    state.userData.luckLevel++;
                    updateDisplay();
                    updateLuckUpgrades();
                    showNotification(`Уровень удачи повышен до ${level+1}!`);
                    saveUserData();
                }
            });
            state.elements.upgradeRewardBtn.addEventListener('click', () => {
                const level = state.userData.rewardLevel;
                if (level < 10 && state.userData.totalCoins >= config.rewardUpgrades[level-1].cost) {
                    state.userData.totalCoins -= config.rewardUpgrades[level-1].cost;
                    state.userData.rewardLevel++;
                    updateDisplay();
                    updateLuckUpgrades();
                    showNotification(`Множитель награды повышен!`);
                    saveUserData();
                }
            });
            state.elements.exchangeAmount.addEventListener('input', updateExchangeUI);
            state.elements.exchangeBtn.addEventListener('click', exchangeTokens);
            state.elements.connectTrustBtn.addEventListener('click', () => {
                state.userData.walletConnected = true;
                state.userData.walletAddress = `0x${Array(40).fill().map(() => Math.floor(Math.random()*16).toString(16)).join('')}`;
                showNotification("Trust Wallet подключен!");
                updateExchangeUI();
                saveUserData();
            });
            state.elements.connectMetaMaskBtn.addEventListener('click', () => {
                state.userData.walletConnected = true;
                state.userData.walletAddress = `0x${Array(40).fill().map(() => Math.floor(Math.random()*16).toString(16)).join('')}`;
                showNotification("MetaMask подключен!");
                updateExchangeUI();
                saveUserData();
            });
            state.elements.withdrawBtn.addEventListener('click', () => {
                if (!state.userData.walletConnected) return showNotification("Сначала подключите кошелек!");
                if (state.userData.totalRutcoin < config.minWithdrawal) return showNotification(`Минимум: ${config.minWithdrawal} $RUT`);
                showNotification(`Запрос на вывод ${state.userData.totalRutcoin.toFixed(2)} $RUT отправлен!`);
                state.userData.totalRutcoin = 0;
                updateExchangeUI();
                saveUserData();
            });
            state.elements.resetStatsBtn.addEventListener('click', () => {
                if (confirm("Вы уверены? Это действие нельзя отменить!")) {
                    localStorage.removeItem(`ruthash_user_${state.userId}`);
                    location.reload();
                }
            });
            state.elements.closeChestBtn.addEventListener('click', () => state.elements.openChestOverlay.classList.remove('active'));
            
            // Кнопки достижений
            state.elements.claimQuest1.addEventListener('click', () => claimQuest('quest1'));
            state.elements.claimQuest2.addEventListener('click', () => claimQuest('quest2'));
            state.elements.claimQuest3.addEventListener('click', () => claimQuest('quest3'));
            
            // Туториал
            document.getElementById('tutorialNext').addEventListener('click', () => {
                document.getElementById('tutorialStep1').classList.remove('active');
                document.getElementById('tutorialStep2').classList.add('active');
            });
            document.getElementById('tutorialNext2').addEventListener('click', () => {
                document.getElementById('tutorialStep2').classList.remove('active');
                document.getElementById('tutorialStep3').classList.add('active');
            });
            document.getElementById('tutorialPrev').addEventListener('click', () => {
                document.getElementById('tutorialStep2').classList.remove('active');
                document.getElementById('tutorialStep1').classList.add('active');
            });
            document.getElementById('tutorialPrev2').addEventListener('click', () => {
                document.getElementById('tutorialStep3').classList.remove('active');
                document.getElementById('tutorialStep2').classList.add('active');
            });
            document.getElementById('tutorialStart').addEventListener('click', () => {
                state.elements.tutorialOverlay.classList.remove('active');
                state.userData.tutorialCompleted = true;
                saveUserData();
            });
            
            // Автосохранение
            setInterval(() => {
                saveUserData();
                updateDisplay();
            }, config.saveInterval);
            
            window.addEventListener('beforeunload', saveUserData);
        };

        window.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>